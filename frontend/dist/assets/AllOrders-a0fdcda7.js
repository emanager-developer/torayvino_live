import{m as r,ax as S,ak as he,cm as me,cn as ue,co as xe,cp as de,cq as ge,j as s,S as pe,ag as je,Q as i,L as fe,b8 as re,ce as be,c4 as v,cr as we,cs as ye,ct as ve,cu as Ne,cv as Q,cw as Se,cx as Pe,cy as Ce,cz as Me,cA as M,aw as $e,K as Le}from"./index-3d958e2c.js";import{D as Oe,a as _e,b as ke,c as B,d as Ae}from"./dropdown-menu-5d0ac71b.js";import{P as Re,a as Ie,C as Ee,b as Te,c as Ue}from"./calendar-8eb02e14.js";import"./chevron-right-840f6817.js";function Ye(){var D,V,Y,q;const[$,G]=r.useState(""),[R,K]=r.useState(""),[x,I]=r.useState({from:null,to:null}),w={},[P,N]=r.useState(1),[L,H]=r.useState(10);w.page=P,w.limit=L,R&&(w.search=R),x.from&&(w.startDate=S(x.from,"yyyy-MM-dd")),x.to&&(w.endDate=S(x.to,"yyyy-MM-dd")),console.log("Query being sent to API:",w);const{data:l,isLoading:E}=he({...w}),J=t=>{G(t.target.value),N(1)};r.useEffect(()=>{const t=setTimeout(()=>{K($.trim())},300);return()=>clearTimeout(t)},[$]);const[O]=me(),[W]=ue(),[X]=xe(),[p,y]=r.useState([]),_=p.map(t=>t==null?void 0:t._id),[Z,T]=r.useState(!1),[U,F]=r.useState(0),[k,z]=r.useState(0),ee=()=>{l!=null&&l.data&&(p.length===(l.data||[]).length?y([]):y([...l.data||[]]))},se=t=>{if(!(l!=null&&l.data))return;if(_.includes(t))y(p.filter(e=>e._id!==t));else{const e=l.data.find(a=>a._id===t);e&&y([...p,e])}},[te]=de(),[ae,{isLoading:ne}]=ge(),ce=async t=>{var e,a,d,u,g,n,c,o,f,j,b,C;const m=window.confirm("Do you want to delete this order?");try{if(m){const h=await te(t);(e=h==null?void 0:h.data)!=null&&e.success?i.success((a=h==null?void 0:h.data)==null?void 0:a.message):(i.error(`${((n=(g=(u=(d=h==null?void 0:h.error)==null?void 0:d.data)==null?void 0:u.error)==null?void 0:g[0])==null?void 0:n.message)||((f=(o=(c=h==null?void 0:h.error)==null?void 0:c.data)==null?void 0:o.error)==null?void 0:f.message)||((b=(j=h==null?void 0:h.error)==null?void 0:j.data)==null?void 0:b.message)||"Something went wrong!"}`),console.log(h))}}catch(h){i.error((C=h==null?void 0:h.data)==null?void 0:C.error)}},le=async()=>{var m;if(!p.length)return i.info("Select orders first");const t=p.map(e=>{var a,d,u,g,n,c;return{invoice:e==null?void 0:e.invoiceNumber,cod_amount:(e==null?void 0:e.totalPrice)||0,recipient_name:((a=e==null?void 0:e.customer)==null?void 0:a.name)||((d=e==null?void 0:e.user)==null?void 0:d.name)||"Customer",recipient_phone:((u=e==null?void 0:e.customer)==null?void 0:u.phone)||((g=e==null?void 0:e.user)==null?void 0:g.phone)||"",recipient_address:((n=e==null?void 0:e.shippingInfo)==null?void 0:n.address)||"N/A",note:((c=e==null?void 0:e.shippingInfo)==null?void 0:c.note)||"N/A"}});try{const e=await W(t),a=(e==null?void 0:e.data)||e;a!=null&&a.success?(i.success((a==null?void 0:a.message)||"Orders sent successfully to Steadfast"),(m=a==null?void 0:a.stockAdjustment)!=null&&m.message&&i.success(`ðŸ“¦ ${a.stockAdjustment.message}`,{duration:4e3}),y([])):(i.error((a==null?void 0:a.message)||"Failed to send orders to Steadfast"),console.log("Steadfast response:",e))}catch(e){console.error(e),i.error((e==null?void 0:e.message)||"Failed to send orders to Steadfast")}},ie=async()=>{var m;if(p.length===0){i.error("Please select orders to send to Pathao");return}T(!0),z(p.length),F(0);const t=p.map(e=>{var a,d,u,g,n,c,o,f,j,b;return{invoiceNumber:e==null?void 0:e.invoiceNumber,totalPrice:(e==null?void 0:e.totalPrice)||0,recipient_name:((a=e==null?void 0:e.customer)==null?void 0:a.name)||((d=e==null?void 0:e.user)==null?void 0:d.name)||"Customer",recipient_phone:((u=e==null?void 0:e.customer)==null?void 0:u.phone)||((g=e==null?void 0:e.user)==null?void 0:g.phone)||"",recipient_address:((n=e==null?void 0:e.shippingInfo)==null?void 0:n.address)||"N/A",special_instruction:((c=e==null?void 0:e.shippingInfo)==null?void 0:c.note)||(e==null?void 0:e.note)||"",products:(e==null?void 0:e.products)||[],user:{name:((o=e==null?void 0:e.customer)==null?void 0:o.name)||((f=e==null?void 0:e.user)==null?void 0:f.name),phone:((j=e==null?void 0:e.customer)==null?void 0:j.phone)||((b=e==null?void 0:e.user)==null?void 0:b.phone)}}});try{const e=await X(t);i.dismiss("pathao-processing");const a=(e==null?void 0:e.data)||e,{successful:d=0,failed:u=0,total:g=0,results:n=[]}=(a==null?void 0:a.data)||{};if(d>0&&i.success(`Successfully processed ${d}/${g} orders to Pathao`),u>0||n&&n.length>0){const c=n==null?void 0:n.filter(o=>o.status==="failed"||o.status==="error");c&&c.length>0?(i.error(`Failed to process ${c.length}/${g} orders`),c.forEach((o,f)=>{var j;if(f<3){let b=`Order ${o.invoiceNumber}: ${o.message}`;if((j=o.error)!=null&&j.errors){const C=Object.entries(o.error.errors).map(([h,oe])=>`${h}: ${oe.join(", ")}`).join("; ");b+=` - ${C}`}i.error(b,{duration:8e3})}}),c.length>3&&i.error(`...and ${c.length-3} more errors. Check console for details.`,{duration:4e3})):u>0&&i.error(`Failed to process ${u}/${g} orders`)}!(a!=null&&a.success)&&(!n||n.length===0)&&i.error((a==null?void 0:a.message)||"Failed to send orders to Pathao"),(m=a==null?void 0:a.stockAdjustment)!=null&&m.message&&i.success(`ðŸ“¦ ${a.stockAdjustment.message}`,{duration:4e3}),(d>0||u>0)&&y([]),console.log("Pathao Response:",e)}catch(e){i.dismiss("pathao-processing"),i.error("Error processing orders: "+((e==null?void 0:e.message)||e)),console.error(e)}finally{T(!1),F(0),z(0)}};let A=null;return E?A=s.jsx(pe,{}):(!E&&((D=l==null?void 0:l.data)==null?void 0:D.length)>0&&(A=(V=l==null?void 0:l.data)==null?void 0:V.map((t,m)=>{var e,a,d,u,g;return s.jsxs("tr",{children:[s.jsx("td",{className:"px-2",children:s.jsx("input",{type:"checkbox",checked:_.includes(t==null?void 0:t._id),onChange:()=>se(t==null?void 0:t._id)})}),s.jsx("td",{children:m+1}),s.jsxs("td",{children:[s.jsxs("p",{children:["INV-",t==null?void 0:t.invoiceNumber]}),s.jsxs("p",{children:["#",t==null?void 0:t._id]}),s.jsx("p",{className:"text-neutral",children:je(t==null?void 0:t.createdAt).format("DD MMM YYYY")})]}),s.jsxs("td",{children:[s.jsxs("p",{children:["Name: ",(e=t==null?void 0:t.customer)==null?void 0:e.name]}),s.jsxs("div",{className:"text-sm text-neutral-content",children:[s.jsxs("p",{children:["Phone: ",(a=t==null?void 0:t.customer)==null?void 0:a.phone]}),s.jsxs("p",{children:["Address: ",(d=t==null?void 0:t.shippingInfo)==null?void 0:d.address]})]})]}),s.jsx("td",{children:s.jsxs("div",{className:"flex -space-x-4 rtl:space-x-reverse",children:[(u=t==null?void 0:t.products)==null?void 0:u.map(n=>{var c,o;return s.jsx("img",{className:"h-10 w-10 rounded-full border-2 border-white",src:`https://api.torayvinobd.store/${(c=n==null?void 0:n.productId)==null?void 0:c.thumbnail}`,alt:(o=n==null?void 0:n.productId)==null?void 0:o.title},`product-${n==null?void 0:n._id}`)}),(g=t==null?void 0:t.kits)==null?void 0:g.map(n=>{var c,o;return s.jsx("img",{className:"h-10 w-10 rounded-full border-2 border-white",src:`https://api.torayvinobd.store/${(c=n==null?void 0:n.kitId)==null?void 0:c.image}`,alt:(o=n==null?void 0:n.kitId)==null?void 0:o.name},`kit-${n==null?void 0:n._id}`)})]})}),s.jsxs("td",{children:[t==null?void 0:t.totalPrice,"TK"]}),s.jsx("td",{children:ne?"Loading...":s.jsxs("select",{value:t==null?void 0:t.status,onChange:async n=>{var o,f,j;const c=await ae({id:t==null?void 0:t._id,status:n.target.value});(o=c==null?void 0:c.data)!=null&&o.success?i.success("Status updated"):i.error(((j=(f=c==null?void 0:c.error)==null?void 0:f.data)==null?void 0:j.message)||"Something went wrong")},className:`cursor-pointer rounded border bg-transparent p-1 text-xs ${(t==null?void 0:t.status)=="pending"&&"border-yellow-500 text-yellow-500"} ${(t==null?void 0:t.status)=="shipped"&&"border-blue-400 text-blue-400"} ${(t==null?void 0:t.status)=="delivered"&&"border-green-400 text-green-400"} ${(t==null?void 0:t.status)=="cancelled"&&"border-red-400 text-red-400"}`,children:[s.jsx("option",{value:"pending",children:"Pending"}),s.jsx("option",{value:"shipped",children:"Shipped"}),s.jsx("option",{value:"delivered",children:"Delivered"}),s.jsx("option",{value:"cancelled",children:"Cancelled"})]})}),s.jsx("td",{children:s.jsxs("div",{className:"flex gap-3",children:[s.jsx(fe,{to:`/admin/order/${t==null?void 0:t._id}`,className:"hover:text-blue-700",children:s.jsx(re,{})}),s.jsx("button",{onClick:()=>ce(t==null?void 0:t._id),className:"hover:text-red-700",children:s.jsx(be,{})})]})})]},t==null?void 0:t._id)})),s.jsxs("section",{children:[Z&&s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",children:s.jsxs("div",{className:"rounded-lg bg-white p-8 text-center shadow-lg",children:[s.jsx("div",{className:"mx-auto mb-4 h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600"}),s.jsx("h3",{className:"mb-2 text-lg font-semibold",children:"Processing Orders to Pathao"}),s.jsx("p",{className:"mb-4 text-gray-600",children:"Please don't leave this page while orders are being processed..."}),s.jsx("div",{className:"mx-auto h-2 w-64 rounded-full bg-gray-200",children:s.jsx("div",{className:"h-2 rounded-full bg-blue-600 transition-all duration-300",style:{width:k>0?`${U/k*100}%`:"0%"}})}),s.jsxs("p",{className:"mt-2 text-sm text-gray-500",children:[U," of ",k," orders processed"]})]})}),s.jsx("div",{className:"mb-2 rounded bg-base-100 p-3",children:s.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-4",children:[s.jsx("h2",{className:"text-xl text-neutral",children:"All Orders"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(v,{variant:"outline",size:"sm",onClick:async()=>{if(!p.length)return i.info("Please select orders to download");try{const t=await O({ids:p.map(a=>a._id)}).unwrap(),m=window.URL.createObjectURL(t),e=document.createElement("a");e.href=m,e.download="orders-selected.csv",e.click(),window.URL.revokeObjectURL(m)}catch{i.error("Export failed")}},children:[s.jsx(we,{})," Download Selected"]}),s.jsxs(v,{variant:"outline",size:"sm",onClick:async()=>{try{const t=await O({query:{page:P,limit:L}}).unwrap(),m=window.URL.createObjectURL(t),e=document.createElement("a");e.href=m,e.download=`orders-page-${P}.csv`,e.click(),window.URL.revokeObjectURL(m)}catch{i.error("Export failed")}},children:[s.jsx(ye,{})," Download Page"]}),s.jsxs(v,{variant:"outline",size:"sm",onClick:async()=>{try{const t=await O({}).unwrap(),m=window.URL.createObjectURL(t),e=document.createElement("a");e.href=m,e.download="orders-all.csv",e.click(),window.URL.revokeObjectURL(m)}catch{i.error("Export failed")}},children:[s.jsx(ve,{})," Download All"]}),(p==null?void 0:p.length)>0&&s.jsxs(Oe,{children:[s.jsx(_e,{children:s.jsxs(v,{variant:"outline",children:["Send to Courier ",s.jsx(Ne,{className:"text-lg"})]})}),s.jsxs(ke,{className:"w-40",children:[s.jsx(B,{children:s.jsxs("button",{onClick:ie,className:"flex items-center gap-2",children:[s.jsx("img",{src:"/images/pathao.png",alt:"Pathao",className:"w-6"}),"Pathao"]})}),s.jsx(Ae,{}),s.jsx(B,{children:s.jsxs("button",{onClick:le,className:"flex items-center gap-2",children:[s.jsx("img",{src:"/images/steadfast.png",alt:"Steadfast",className:"w-6"}),"Steadfast"]})})]})]})]})]})}),s.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Q,{className:"text-sm",children:"Show"}),s.jsxs(Se,{value:String(L),onValueChange:t=>{H(Number(t)),N(1)},children:[s.jsx(Pe,{className:"h-8 w-20",children:s.jsx(Ce,{})}),s.jsxs(Me,{children:[s.jsx(M,{value:"10",children:"10"}),s.jsx(M,{value:"25",children:"25"}),s.jsx(M,{value:"50",children:"50"}),s.jsx(M,{value:"100",children:"100"})]})]}),s.jsx(Q,{className:"text-sm",children:"per page"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(Re,{children:[s.jsx(Ie,{asChild:!0,children:s.jsxs(v,{variant:"outline",size:"sm",className:$e("h-8 justify-start text-left font-normal",!x.from&&!x.to&&"text-muted-foreground"),children:[s.jsx(Ee,{className:"mr-2 h-4 w-4"}),x.from?x.to?s.jsxs(s.Fragment,{children:[S(x.from,"MMM dd, yyyy")," -"," ",S(x.to,"MMM dd, yyyy")]}):S(x.from,"MMM dd, yyyy"):s.jsx("span",{children:"Filter by date"})]})}),s.jsxs(Te,{className:"w-auto p-0",align:"end",children:[s.jsx(Ue,{initialFocus:!0,mode:"range",defaultMonth:x.from,selected:x,onSelect:t=>{I(t||{from:null,to:null}),N(1)},numberOfMonths:2}),(x.from||x.to)&&s.jsx("div",{className:"border-t p-2",children:s.jsx(v,{size:"sm",variant:"outline",className:"w-full",onClick:()=>{I({from:null,to:null}),N(1)},children:"Clear dates"})})]})]}),s.jsx("input",{type:"text",placeholder:"Search by name, phone or email",value:$,onChange:J,className:"h-8 w-48 rounded border px-2 text-sm"})]})]}),s.jsxs("div",{className:"relative flex flex-col justify-between overflow-x-auto pb-4 shadow-lg",children:[s.jsxs("table",{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-2",children:s.jsx("input",{type:"checkbox",onChange:ee,checked:(l==null?void 0:l.data)&&_.length===l.data.length})}),s.jsx("th",{children:"SL"}),s.jsx("th",{children:"Order"}),s.jsx("th",{children:"Customer"}),s.jsx("th",{children:"Items"}),s.jsx("th",{children:"Total Price"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Action"})]})}),s.jsx("tbody",{children:A})]}),((Y=l==null?void 0:l.meta)==null?void 0:Y.pages)>1&&s.jsx(Le,{pages:(q=l==null?void 0:l.meta)==null?void 0:q.pages,currentPage:P,setCurrentPage:N})]})]}))}export{Ye as default};
