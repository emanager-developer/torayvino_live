import{p,aA as N,an as he,cm as ue,cn as me,co as xe,cp as de,cq as ge,j as s,S as pe,aj as je,Q as i,L as fe,b9 as be,ce as re,c5 as w,cr as we,cs as ye,ct as ve,cu as Ne,cv as Y,cw as Se,cx as Pe,cy as Ce,cz as Me,cA as P,az as $e,T as Le}from"./index-f981d823.js";import{D as Oe,a as _e,b as Ae,c as q,d as ke}from"./dropdown-menu-e69bdeea.js";import{P as Re,a as Ie,C as Te,b as Ee,c as Ue}from"./calendar-917cd291.js";import"./chevron-right-9544761f.js";function Ye(){var F,z,D,V;const[C,Q]=p.useState(""),[A,B]=p.useState(""),[m,k]=p.useState({from:null,to:null}),f={},[S,y]=p.useState(1),[M,G]=p.useState(10);f.page=S,f.limit=M,A&&(f.search=A),m.from&&(f.startDate=N(m.from,"yyyy-MM-dd")),m.to&&(f.endDate=N(m.to,"yyyy-MM-dd")),console.log("Query being sent to API:",f);const{data:c,isLoading:R}=he({...f}),H=t=>{Q(t.target.value),y(1)};p.useEffect(()=>{const t=setTimeout(()=>{B(C.trim())},300);return()=>clearTimeout(t)},[C]);const[$]=ue(),[K]=me(),[J]=xe(),[g,r]=p.useState([]),L=g.map(t=>t==null?void 0:t._id),[W,I]=p.useState(!1),[T,E]=p.useState(0),[O,U]=p.useState(0),X=()=>{c!=null&&c.data&&(g.length===(c.data||[]).length?r([]):r([...c.data||[]]))},Z=t=>{if(!(c!=null&&c.data))return;if(L.includes(t))r(g.filter(e=>e._id!==t));else{const e=c.data.find(n=>n._id===t);e&&r([...g,e])}},[ee]=de(),[se,{isLoading:te}]=ge(),ae=async t=>{var e,n,x,u,d;const o=window.confirm("Do you want to delete this order?");try{if(o){const a=await ee(t);(e=a==null?void 0:a.data)!=null&&e.success?i.success((n=a==null?void 0:a.data)==null?void 0:n.message):(i.error(((u=(x=a==null?void 0:a.error)==null?void 0:x.data)==null?void 0:u.message)||"Something went wrong"),console.log(a))}}catch(a){i.error((d=a==null?void 0:a.data)==null?void 0:d.error)}},ne=async()=>{var o;if(!g.length)return i.info("Select orders first");const t=g.map(e=>{var n,x,u,d,a,l;return{invoice:e==null?void 0:e.invoiceNumber,cod_amount:(e==null?void 0:e.totalPrice)||0,recipient_name:((n=e==null?void 0:e.customer)==null?void 0:n.name)||((x=e==null?void 0:e.user)==null?void 0:x.name)||"Customer",recipient_phone:((u=e==null?void 0:e.customer)==null?void 0:u.phone)||((d=e==null?void 0:e.user)==null?void 0:d.phone)||"",recipient_address:((a=e==null?void 0:e.shippingInfo)==null?void 0:a.address)||"N/A",note:((l=e==null?void 0:e.shippingInfo)==null?void 0:l.note)||"N/A"}});try{const e=await K(t),n=(e==null?void 0:e.data)||e;n!=null&&n.success?(i.success((n==null?void 0:n.message)||"Orders sent successfully to Steadfast"),(o=n==null?void 0:n.stockAdjustment)!=null&&o.message&&i.success(`ðŸ“¦ ${n.stockAdjustment.message}`,{duration:4e3}),r([])):(i.error((n==null?void 0:n.message)||"Failed to send orders to Steadfast"),console.log("Steadfast response:",e))}catch(e){console.error(e),i.error((e==null?void 0:e.message)||"Failed to send orders to Steadfast")}},ce=async()=>{var o;if(g.length===0){i.error("Please select orders to send to Pathao");return}I(!0),U(g.length),E(0);const t=g.map(e=>{var n,x,u,d,a,l,h,b,j,v;return{invoiceNumber:e==null?void 0:e.invoiceNumber,totalPrice:(e==null?void 0:e.totalPrice)||0,recipient_name:((n=e==null?void 0:e.customer)==null?void 0:n.name)||((x=e==null?void 0:e.user)==null?void 0:x.name)||"Customer",recipient_phone:((u=e==null?void 0:e.customer)==null?void 0:u.phone)||((d=e==null?void 0:e.user)==null?void 0:d.phone)||"",recipient_address:((a=e==null?void 0:e.shippingInfo)==null?void 0:a.address)||"N/A",special_instruction:((l=e==null?void 0:e.shippingInfo)==null?void 0:l.note)||(e==null?void 0:e.note)||"",products:(e==null?void 0:e.products)||[],user:{name:((h=e==null?void 0:e.customer)==null?void 0:h.name)||((b=e==null?void 0:e.user)==null?void 0:b.name),phone:((j=e==null?void 0:e.customer)==null?void 0:j.phone)||((v=e==null?void 0:e.user)==null?void 0:v.phone)}}});try{const e=await J(t);i.dismiss("pathao-processing");const n=(e==null?void 0:e.data)||e,{successful:x=0,failed:u=0,total:d=0,results:a=[]}=(n==null?void 0:n.data)||{};if(x>0&&i.success(`Successfully processed ${x}/${d} orders to Pathao`),u>0||a&&a.length>0){const l=a==null?void 0:a.filter(h=>h.status==="failed"||h.status==="error");l&&l.length>0?(i.error(`Failed to process ${l.length}/${d} orders`),l.forEach((h,b)=>{var j;if(b<3){let v=`Order ${h.invoiceNumber}: ${h.message}`;if((j=h.error)!=null&&j.errors){const le=Object.entries(h.error.errors).map(([ie,oe])=>`${ie}: ${oe.join(", ")}`).join("; ");v+=` - ${le}`}i.error(v,{duration:8e3})}}),l.length>3&&i.error(`...and ${l.length-3} more errors. Check console for details.`,{duration:4e3})):u>0&&i.error(`Failed to process ${u}/${d} orders`)}!(n!=null&&n.success)&&(!a||a.length===0)&&i.error((n==null?void 0:n.message)||"Failed to send orders to Pathao"),(o=n==null?void 0:n.stockAdjustment)!=null&&o.message&&i.success(`ðŸ“¦ ${n.stockAdjustment.message}`,{duration:4e3}),(x>0||u>0)&&r([]),console.log("Pathao Response:",e)}catch(e){i.dismiss("pathao-processing"),i.error("Error processing orders: "+((e==null?void 0:e.message)||e)),console.error(e)}finally{I(!1),E(0),U(0)}};let _=null;return R?_=s.jsx(pe,{}):(!R&&((F=c==null?void 0:c.data)==null?void 0:F.length)>0&&(_=(z=c==null?void 0:c.data)==null?void 0:z.map((t,o)=>{var e,n,x,u,d;return s.jsxs("tr",{children:[s.jsx("td",{className:"px-2",children:s.jsx("input",{type:"checkbox",checked:L.includes(t==null?void 0:t._id),onChange:()=>Z(t==null?void 0:t._id)})}),s.jsx("td",{children:o+1}),s.jsxs("td",{children:[s.jsxs("p",{children:["INV-",t==null?void 0:t.invoiceNumber]}),s.jsxs("p",{children:["#",t==null?void 0:t._id]}),s.jsx("p",{className:"text-neutral",children:je(t==null?void 0:t.createdAt).format("DD MMM YYYY")})]}),s.jsxs("td",{children:[s.jsxs("p",{children:["Name: ",(e=t==null?void 0:t.customer)==null?void 0:e.name]}),s.jsxs("div",{className:"text-sm text-neutral-content",children:[s.jsxs("p",{children:["Phone: ",(n=t==null?void 0:t.customer)==null?void 0:n.phone]}),s.jsxs("p",{children:["Address: ",(x=t==null?void 0:t.shippingInfo)==null?void 0:x.address]})]})]}),s.jsx("td",{children:s.jsxs("div",{className:"flex -space-x-4 rtl:space-x-reverse",children:[(u=t==null?void 0:t.products)==null?void 0:u.map(a=>{var l,h;return s.jsx("img",{className:"h-10 w-10 rounded-full border-2 border-white",src:`https://api.torayvinobd.store/${(l=a==null?void 0:a.productId)==null?void 0:l.thumbnail}`,alt:(h=a==null?void 0:a.productId)==null?void 0:h.title},`product-${a==null?void 0:a._id}`)}),(d=t==null?void 0:t.kits)==null?void 0:d.map(a=>{var l,h;return s.jsx("img",{className:"h-10 w-10 rounded-full border-2 border-white",src:`https://api.torayvinobd.store/${(l=a==null?void 0:a.kitId)==null?void 0:l.image}`,alt:(h=a==null?void 0:a.kitId)==null?void 0:h.name},`kit-${a==null?void 0:a._id}`)})]})}),s.jsxs("td",{children:[t==null?void 0:t.totalPrice,"TK"]}),s.jsx("td",{children:te?"Loading...":s.jsxs("select",{value:t==null?void 0:t.status,onChange:async a=>{var h,b,j;const l=await se({id:t==null?void 0:t._id,status:a.target.value});(h=l==null?void 0:l.data)!=null&&h.success?i.success("Status updated"):i.error(((j=(b=l==null?void 0:l.error)==null?void 0:b.data)==null?void 0:j.message)||"Something went wrong")},className:`cursor-pointer rounded border bg-transparent p-1 text-xs ${(t==null?void 0:t.status)=="pending"&&"border-yellow-500 text-yellow-500"} ${(t==null?void 0:t.status)=="shipped"&&"border-blue-400 text-blue-400"} ${(t==null?void 0:t.status)=="delivered"&&"border-green-400 text-green-400"} ${(t==null?void 0:t.status)=="cancelled"&&"border-red-400 text-red-400"}`,children:[s.jsx("option",{value:"pending",children:"Pending"}),s.jsx("option",{value:"shipped",children:"Shipped"}),s.jsx("option",{value:"delivered",children:"Delivered"}),s.jsx("option",{value:"cancelled",children:"Cancelled"})]})}),s.jsx("td",{children:s.jsxs("div",{className:"flex gap-3",children:[s.jsx(fe,{to:`/admin/order/${t==null?void 0:t._id}`,className:"hover:text-blue-700",children:s.jsx(be,{})}),s.jsx("button",{onClick:()=>ae(t==null?void 0:t._id),className:"hover:text-red-700",children:s.jsx(re,{})})]})})]},t==null?void 0:t._id)})),s.jsxs("section",{children:[W&&s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",children:s.jsxs("div",{className:"rounded-lg bg-white p-8 text-center shadow-lg",children:[s.jsx("div",{className:"mx-auto mb-4 h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600"}),s.jsx("h3",{className:"mb-2 text-lg font-semibold",children:"Processing Orders to Pathao"}),s.jsx("p",{className:"mb-4 text-gray-600",children:"Please don't leave this page while orders are being processed..."}),s.jsx("div",{className:"mx-auto h-2 w-64 rounded-full bg-gray-200",children:s.jsx("div",{className:"h-2 rounded-full bg-blue-600 transition-all duration-300",style:{width:O>0?`${T/O*100}%`:"0%"}})}),s.jsxs("p",{className:"mt-2 text-sm text-gray-500",children:[T," of ",O," orders processed"]})]})}),s.jsx("div",{className:"mb-2 rounded bg-base-100 p-3",children:s.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-4",children:[s.jsx("h2",{className:"text-xl text-neutral",children:"All Orders"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(w,{variant:"outline",size:"sm",onClick:async()=>{if(!g.length)return i.info("Please select orders to download");try{const t=await $({ids:g.map(n=>n._id)}).unwrap(),o=window.URL.createObjectURL(t),e=document.createElement("a");e.href=o,e.download="orders-selected.csv",e.click(),window.URL.revokeObjectURL(o)}catch{i.error("Export failed")}},children:[s.jsx(we,{})," Download Selected"]}),s.jsxs(w,{variant:"outline",size:"sm",onClick:async()=>{try{const t=await $({query:{page:S,limit:M}}).unwrap(),o=window.URL.createObjectURL(t),e=document.createElement("a");e.href=o,e.download=`orders-page-${S}.csv`,e.click(),window.URL.revokeObjectURL(o)}catch{i.error("Export failed")}},children:[s.jsx(ye,{})," Download Page"]}),s.jsxs(w,{variant:"outline",size:"sm",onClick:async()=>{try{const t=await $({}).unwrap(),o=window.URL.createObjectURL(t),e=document.createElement("a");e.href=o,e.download="orders-all.csv",e.click(),window.URL.revokeObjectURL(o)}catch{i.error("Export failed")}},children:[s.jsx(ve,{})," Download All"]}),(g==null?void 0:g.length)>0&&s.jsxs(Oe,{children:[s.jsx(_e,{children:s.jsxs(w,{variant:"outline",children:["Send to Courier ",s.jsx(Ne,{className:"text-lg"})]})}),s.jsxs(Ae,{className:"w-40",children:[s.jsx(q,{children:s.jsxs("button",{onClick:ce,className:"flex items-center gap-2",children:[s.jsx("img",{src:"/images/pathao.png",alt:"Pathao",className:"w-6"}),"Pathao"]})}),s.jsx(ke,{}),s.jsx(q,{children:s.jsxs("button",{onClick:ne,className:"flex items-center gap-2",children:[s.jsx("img",{src:"/images/steadfast.png",alt:"Steadfast",className:"w-6"}),"Steadfast"]})})]})]})]})]})}),s.jsxs("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Y,{className:"text-sm",children:"Show"}),s.jsxs(Se,{value:String(M),onValueChange:t=>{G(Number(t)),y(1)},children:[s.jsx(Pe,{className:"h-8 w-20",children:s.jsx(Ce,{})}),s.jsxs(Me,{children:[s.jsx(P,{value:"10",children:"10"}),s.jsx(P,{value:"25",children:"25"}),s.jsx(P,{value:"50",children:"50"}),s.jsx(P,{value:"100",children:"100"})]})]}),s.jsx(Y,{className:"text-sm",children:"per page"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(Re,{children:[s.jsx(Ie,{asChild:!0,children:s.jsxs(w,{variant:"outline",size:"sm",className:$e("h-8 justify-start text-left font-normal",!m.from&&!m.to&&"text-muted-foreground"),children:[s.jsx(Te,{className:"mr-2 h-4 w-4"}),m.from?m.to?s.jsxs(s.Fragment,{children:[N(m.from,"MMM dd, yyyy")," -"," ",N(m.to,"MMM dd, yyyy")]}):N(m.from,"MMM dd, yyyy"):s.jsx("span",{children:"Filter by date"})]})}),s.jsxs(Ee,{className:"w-auto p-0",align:"end",children:[s.jsx(Ue,{initialFocus:!0,mode:"range",defaultMonth:m.from,selected:m,onSelect:t=>{k(t||{from:null,to:null}),y(1)},numberOfMonths:2}),(m.from||m.to)&&s.jsx("div",{className:"border-t p-2",children:s.jsx(w,{size:"sm",variant:"outline",className:"w-full",onClick:()=>{k({from:null,to:null}),y(1)},children:"Clear dates"})})]})]}),s.jsx("input",{type:"text",placeholder:"Search by name, phone or email",value:C,onChange:H,className:"h-8 w-48 rounded border px-2 text-sm"})]})]}),s.jsxs("div",{className:"relative flex flex-col justify-between overflow-x-auto pb-4 shadow-lg",children:[s.jsxs("table",{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-2",children:s.jsx("input",{type:"checkbox",onChange:X,checked:(c==null?void 0:c.data)&&L.length===c.data.length})}),s.jsx("th",{children:"SL"}),s.jsx("th",{children:"Order"}),s.jsx("th",{children:"Customer"}),s.jsx("th",{children:"Items"}),s.jsx("th",{children:"Total Price"}),s.jsx("th",{children:"Status"}),s.jsx("th",{children:"Action"})]})}),s.jsx("tbody",{children:_})]}),((D=c==null?void 0:c.meta)==null?void 0:D.pages)>1&&s.jsx(Le,{pages:(V=c==null?void 0:c.meta)==null?void 0:V.pages,currentPage:S,setCurrentPage:y})]})]}))}export{Ye as default};
